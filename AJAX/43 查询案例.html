<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>评论列表</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <style>
    .badge {
      float: right;
      margin-right: 5px;
    }

    .my-page {
      margin: 0 5px;
    }

    .all-page-content {
      margin-left: 5px;
    }
  </style>
</head>

<body style="padding: 15px;">

  <!-- 评论面板 -->
  <div class="panel panel-primary">
    <div class="panel-heading">
      <h3 class="panel-title">发表评论</h3>
    </div>
    <form class="panel-body cmt-form">
      <div>评论人：</div>
      <input type="text" class="form-control" name="username" autocomplete="off" />
      <div>评论内容：</div>
      <textarea class="form-control" name="content"></textarea>
      <button type="submit" class="btn btn-primary submit">发表评论</button>
    </form>
  </div>


  <!-- 评论列表 -->
  <ul class="list-group">
    <!-- <li class="list-group-item">
       <span>评论内容</span>
       <span class="badge del" style="cursor:pointer; background-color: lightgray;">删除</span> 
       <span class="badge" style="background-color: #F0AD4E;">评论时间：xxx</span>
       <span class="badge" style="background-color: #5BC0DE;">评论人：xxx</span>
    </li> -->
  </ul>

  <!-- 分页器 -->
  <nav>
    <ul class="pagination">
      <li>
        <button class="last">
          <span>&laquo;</span>
        </button>
      </li>
      <li class="my-page">
        <span class="page-show"></span>
      </li>
      <li>
        <button class="next">
          <span>&raquo;</span>
        </button>
      </li>
      <li class="all-page-content">
        <span>共计:<span class="all-page"></span>页</span>
      </li>
    </ul>
  </nav>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="js/form-serialize.js"></script>
  <script>
    // 1. 默认上来展示所有评论列表数据（注意不区分用户了）感受下大家数据互相影响，也可以看到别人评论
    function show(page) {
      const p = axios({
        url: 'https://hmajax.itheima.net/api/cmtlist',
        params: { page }
      })
      p.then(res => {
        // console.log(res.data)
        const list = res.data.data
        const allpage = res.data.allPage
        render(allpage, list)
        document.querySelector('.page-show').innerHTML = page
      })
    }
    show(1)
    function render(allpage, list) {
      document.querySelector('.list-group').innerHTML = list.map(item => {
        const { content, id, username, time } = item
        const cur = new Date(time)
        const year = cur.getFullYear()
        const month = cur.getMonth() + 1 > 10 ? cur.getMonth() + 1 : '0' + cur.getMonth()
        const date = cur.getDate() > 10 ? cur.getDate() : '0' + cur.getDate()
        const hour = cur.getHours() > 10 ? cur.getHours() : '0' + cur.getHours()
        const minute = cur.getMinutes() > 10 ? cur.getMinutes() : '0' + cur.getMinutes()
        const second = cur.getSeconds() > 10 ? cur.getSeconds() : '0' + cur.getSeconds()

        return `<li class="list-group-item" data-id=${id}>
       <span>${content}</span>
       <span class="badge del" style="cursor:pointer; background-color: lightgray;">删除</span> 
       <span class="badge" style="background-color: #F0AD4E;">评论时间：${year}-${month}-${date} ${hour}:${minute}:${second}</span>
       <span class="badge" style="background-color: #5BC0DE;">评论人：${username}</span>
    </li> `
      }).join("")
      document.querySelector('.all-page').innerHTML = allpage
    }

    // 2. 新增评论功能
    document.querySelector('.submit').addEventListener('click', function (e) {
      // console(11)
      e.preventDefault()
      const form = document.querySelector('.cmt-form')
      // console.log(form)
      const item = serialize(form, { hash: true, empty: false })
      const { username, content } = item
      if (username && content && username.trim() && content.trim()) {

        console.log(item)
        axios({
          url: 'https://hmajax.itheima.net/api/addcmt',
          method: 'post',
          data: item
        }).then(res => {
          show(1)
          form.reset(a)

        }).catch(err => console.dir(err))
      }
      // username = username.trim()
      // content = content.trim()
      // const time = getTime()
      // console.log(time)

    })


    // 3. 删除评论功能
    document.querySelector('.list-group').addEventListener('click', function (e) {
      if (e.target.classList.contains('del')) {
        // console.log(e.target)
        const parent = e.target.parentNode
        console.log(parent)
        const id = parent.dataset.id
        axios({
          url: 'https://hmajax.itheima.net/api/delcmt',
          params: { id }
        }).then(res => {

          pagenow = +document.querySelector('.page-show').innerHTML
          const allpage = res.data.allPage
          console.log(allpage)
          if (pagenow > allpage) {
            show(allpage)
          } else {
            show(pagenow)
          }

        })
      }
    })


    // 4. 分页切换评论列表数据功能
    document.querySelector('.last').addEventListener('click', last)
    document.querySelector('.next').addEventListener('click', next)

    function last() {
      let page = +document.querySelector('.page-show').innerHTML
      const allpage = +document.querySelector('.all-page').innerHTML
      page = page - 1 < 1 ? 1 : page - 1
      // console.log(page)
      show(page)
    }

    function next() {
      let page = +document.querySelector('.page-show').innerHTML
      const allpage = +document.querySelector('.all-page').innerHTML
      page = page + 1 > allpage ? allpage : page + 1
      // console.log(page)
      show(page)
    }



  </script>
</body>

</html>